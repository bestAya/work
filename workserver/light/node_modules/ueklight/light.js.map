{"version":3,"sources":["../../cookie/light.js"],"names":["http","require","config","path","fs","ejs","async","light","getInfo","postInfo","useInfo","rootUrl","process","cwd","port","fn","arguments","length","console","log","createServer","req","res","methods","method","ext","extname","url","staticType","indexOf","dir","join","resolve","staticDir","setHeader","type","stat","err","writeHead","end","createReadStream","pipe","run","listen","series","next","num","eachSeries","item","next1","extend","request","sendState","arr","flag","i","reg","eval","test","current","params","result","exec","j","attr","callback","nextIndex","nextInfo","location","originUrl","saveInfo","infoArr","match","map","substr","str","replace","obj","push","redirect","send","message","sendFile","fullpath","toString","render","data","views","readFile","data1","download","name","Math","random","Router","module","exports"],"mappings":"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","file":"light.js","sourcesContent":["var http = require(\"http\")\nvar config = require(\"./config.js\")\nvar path = require(\"path\")\nvar fs = require(\"fs\")\nvar ejs=require(\"./ejs\");\nvar async=require(\"async\");\nclass light {\n    constructor() {\n        this.getInfo = [];\n        this.postInfo = [];\n        this.useInfo=[];\n        this.rootUrl = process.cwd();\n    }\n\n    listen(port, fn) {\n        if (arguments.length == 0) {\n            var port = config.port;\n            var fn = function () {\n                console.log(port)\n            }\n        } else if(arguments.length == 1) {\n            if (typeof port == \"number\") {\n                var port = port;\n                var fn = function () {\n                    console.log(port)\n                }\n\n            } else if (typeof port == \"function\") {\n                var fn = port;\n                var port = config.port;\n\n            } else {\n                var port = config.port;\n                var fn = function () {\n                    console.log(port)\n                }\n\n            }\n        } else if (arguments.length == 2) {\n            var port = port;\n            var fn = fn;\n        }\n\n        this.port = port;\n\n        http.createServer((req, res) => {\n            var methods = (req.method);\n            var ext=path.extname(req.url);\n            if(ext&&config.staticType.indexOf(ext)>-1){\n                  var dir=path.join(path.resolve(config.staticDir),req.url);\n                  res.setHeader(\"content-type\",config.type[ext]+\";charset=utf-8\");\n                fs.stat(dir,function (err) {\n                        if(err){\n                            res.writeHead(404);\n                            res.end(\"err\");\n                        }else{\n                            fs.createReadStream(dir).pipe(res);\n                        }\n                })\n\n            }else {\n                this.run(req.method, req, res)\n            }\n\n        }).listen(port, function () {\n            if (fn) {\n                fn();\n            }\n        })\n    }\n\n    run(type, req, res) {\n        var url = req.url;\n\n        if (url == \"/favicon.ico\") {\n            res.end();\n        } else {\n\n            /*post data end\n\n               保证我们访问  中间件的内容的时候，保证中间件都加载成功了\n             异步*  为了动态的路由*/\n\n\n             async.series([(next)=>{\n//插件\n                 var num=0;\n                 if(this.useInfo.length==0){\n                     var num=-1;\n                     next();\n                 }else{\n\n                     async.eachSeries(this.useInfo,(item,next1)=> {\n                       item(req,res,next1);\n                     },()=> {\n                         next();\n                     })\n                 }\n             }],()=> {\n                 this.extend(req, res);\n                 this.request(req,res,type,url)\n             })\n\n/*\n             new Promise((reslove,reject)=>{\n                 //插件\n                 var num=0;\n                 if(this.useInfo.length==0){\n                     var num=0;\n                     reslove();\n                 }else{\n                 for(var i=0;i<this.useInfo.length;i++){\n\n                     new Promise((reslove1,reject1)=>{\n                         this.useInfo[i](req,res,reslove1);\n                     }).then(()=>{\n                            num++;\n                            if(num==i){\n                                reslove();\n                            }\n                     })\n\n                 }}\n\n             }).then( ()=> {\n                 this.extend(req, res);\n                 this.request(req,res,type,url)\n             })\n */\n\n        }\n\n    }\n\n    request(req,res,type,url){\n        res.sendState=\"ok\";\n        if(type==\"GET\"){\n            var arr=this.getInfo;\n        }else if(type==\"POST\"){\n            var arr=this.postInfo;\n        }\n        var flag = true;\n        for (var i = 0; i < arr.length; i++) {\n            var reg = eval(arr[i].url);\n            if (reg.test(url)) {\n                this.current=i;\n                flag = false\n                req.params = {};\n                var result = reg.exec(url);\n                for (var j = 0; j < result.length; j++) {\n                    req.params[arr[i].attr[j]] = result[j + 1];\n\n                }\n                arr[i].callback(req, res,()=>{\n                    this.next(req,res)\n                });\n                break;\n            }\n\n        }\n\n        if (flag) {\n            res.end(\"err\");\n        }\n\n    }\n\n    next(req,res){\n        var nextIndex=this.current+1;\n        var nextInfo=this.getInfo[nextIndex];\n        res.writeHead(302,{location:nextInfo.originUrl});\n        res.end();\n\n    }\n    get(url, fn) {\n        this.saveInfo(url,fn,\"get\")\n    }\n    post(url, fn) {\n        this.saveInfo(url,fn,\"post\")\n    }\n    all(url,fn){\n        this.saveInfo(url,fn,\"get\")\n        this.saveInfo(url,fn,\"post\")\n    }\n\n    saveInfo(url,fn,type){\n        var infoArr=type==\"get\"?this.getInfo:this.postInfo;\n        //路由的匹配\n        var arr = url.match(/:([^\\/]+)/g) || [];\n        arr = arr.map(function (item) {\n            return item.substr(1);\n        });\n        var str = url.replace(/:[^\\/]+/g, \"([^\\/]+)\");\n        str = str.replace(/\\//g, '\\\\/');\n        str = \"/^\" + (str) + '[\\\\/]?(?:\\\\?.*)?$/';\n        var obj = {};\n        obj[\"url\"] = str;\n        obj[\"originUrl\"]=url;\n        obj.callback = fn;\n        obj.attr = arr;\n        infoArr.push(obj);\n    }\n\n    extend(req, res) {\n        res.redirect=function(url){\n            res.writeHead(302,{\n                \"location\":url\n            })\n            res.end();\n\n        }\n        res.send = function (message) {\n            res.setHeader(\"content-type\",\"text/html;charset=utf-8\");\n            res.end(message);\n        };\n        res.sendFile = (url) => {\n            var fullpath = path.join(this.rootUrl, url);\n            fs.stat(fullpath, function (err) {\n                if (err) {\n                    res.end(err.toString())\n                } else {\n                    fs.createReadStream(fullpath).pipe(res);\n                }\n            })\n        }\n\n        res.render=function(url,data){\n            var url=path.join(path.resolve(config.views),url);\n            fs.readFile(url,function(err,data1){\n                if(err){\n                 res.writeHead(404);\n                 res.end();\n                }else{\n                res.end(ejs(data1.toString(),data))}\n\n            })\n        }\n\n       res.download=(url,name=\"download\"+Math.random())=>{\n            var url=path.join(this.rootUrl,url);\n            res.setHeader(\"Content-Disposition\", \"attachment; filename=\"+name);\n            res.setHeader(\"Content-Type\",\"octet-stream\");\n            fs.createReadStream(url).pipe(res);\n        }\n    }\n    use(fn){\n        this.useInfo.push(fn);\n    }\n}\n\nvar obj=new light();\n\nfunction fn(){\n    return obj;\n}\n\nfn.Router=function(){\n    return obj;\n}\n\nmodule.exports =fn;"]}